#!/usr/bin/env bash

set -euo pipefail

test_script="add_N_to_sumstat"
initial_dir=$(pwd)"/${test_script}"
curr_case=""

mkdir "${initial_dir}"
cd "${initial_dir}"

#=================================================================================
# Helpers
#=================================================================================

function _setup {
  mkdir "${1}"
  cd "${1}"
  curr_case="${1}"
}

function _check_results {
  obs=$1
  exp=$2
  if ! diff ${obs} ${exp} &> ./difference; then
    echo "- [FAIL] ${curr_case}"
    cat ./difference 
    exit 1
  fi

}

function _run_script {
priority="${1}"

  "${test_script}.sh" ./input_file.tsv.gz ./metafile.yaml "${priority}" > ./observed-results.tsv
  _check_results ./observed-results.tsv ./expected-result_1.tsv

  echo "- [OK] ${curr_case}"

  cd "${initial_dir}"
}

echo ">> Test ${test_script}"

#=================================================================================
# Cases
#=================================================================================

#---------------------------------------------------------------------------------
# add n

_setup "add effectiveN"

cat <<EOF > ./metafile.yaml
stats_EffectiveN: 13688.4
EOF

cat <<EOF | gzip -c > ./input_file.tsv.gz
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663
EOF

cat <<EOF > ./expected-result_1.tsv
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	13688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	13688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	13688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	13688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	13688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	13688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	13688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13688
EOF

_run_script "effectiveN"

#---------------------------------------------------------------------------------
# keep n

# Commented out as I am unsure if we actually should keep N when effectiveN is selected
# Preferably N is always total and never effectiveN. 
# This is notw the case and effective n is instead named Neff.
#_setup "Keep N"
#
#cat <<EOF > ./metafile.yaml
#stats_EffectiveN: 13688.4
#cleansumstats_col_N: N
#EOF
#
#cat <<EOF | gzip -c > ./input_file.tsv.gz
#0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N
#1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	14688.4
#10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	14688.4
#100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	17688.4
#1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	14688.4
#1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	16688.4
#1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	18688.4
#1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688.4
#1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	11688.4
#1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698.4
#EOF
#
#cat <<EOF > ./expected-result_1.tsv
#0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N
#1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	14688
#10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	14688
#100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	17688
#1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	14688
#1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	16688
#1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	18688
#1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688
#1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	11688
#1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698
#EOF
#
#_run_script "effectiveN"

#---------------------------------------------------------------------------------
# get n from caseN and controlN
# The idea is to not use the existing N
_setup "use CaseN and controlN"

cat <<EOF > ./metafile.yaml
stats_EffectiveN: 13688
cleansumstats_col_CaseN: CaseN
cleansumstats_col_ControlN: ControlN
cleansumstats_col_N: N
EOF

cat <<EOF | gzip -c > ./input_file.tsv.gz
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N	CaseN	ControlN
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	14688	24688	44688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	14688	24688	44688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	17688	27688	47688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	14688	24688	44688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	16688	26688	46688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	18688	22288	48688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688	23688	43688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	11688	22688	41688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698	22688	41688
EOF

cat <<EOF > ./expected-result_1.tsv
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N	CaseN	ControlN
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	63610	24688	44688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	63610	24688	44688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	70069	27688	47688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	63610	24688	44688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	67924	26688	46688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	61156	22288	48688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	61439	23688	43688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	58768	22688	41688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	58768	22688	41688
EOF

_run_script "effectiveN"

#---------------------------------------------------------------------------------
# get n from existing N, because that is per definition total N
_setup "use N for totalN"

cat <<EOF > ./metafile.yaml
stats_EffectiveN: 13688
cleansumstats_col_CaseN: CaseN
cleansumstats_col_ControlN: ControlN
cleansumstats_col_N: N
EOF

cat <<EOF | gzip -c > ./input_file.tsv.gz
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N	CaseN	ControlN
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	14688	24688	44688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	14688	24688	44688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	17688	27688	47688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	14688	24688	44688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	16688	26688	46688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	18688	22288	48688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688	23688	43688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	11688	22688	41688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698	22688	41688
EOF

cat <<EOF > ./expected-result_1.tsv
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	N	CaseN	ControlN
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	14688	24688	44688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	14688	24688	44688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	17688	27688	47688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	14688	24688	44688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	16688	26688	46688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	18688	22288	48688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688	23688	43688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	11688	22688	41688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698	22688	41688
EOF

_run_script "totalN"

#---------------------------------------------------------------------------------
# get n from caseN and controlN
_setup "use CaseN and controlN for totalN"

cat <<EOF > ./metafile.yaml
stats_EffectiveN: 13688
cleansumstats_col_CaseN: CaseN
cleansumstats_col_ControlN: ControlN
stats_TotalN: 13688
EOF

cat <<EOF | gzip -c > ./input_file.tsv.gz
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	CaseN	ControlN
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	24688	44688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	24688	44688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	27688	47688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	24688	44688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	26688	46688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	22288	48688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	23688	43688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	22688	41688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698	41688
EOF

cat <<EOF > ./expected-result_1.tsv
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P	CaseN	ControlN	N
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	24688	44688	69376
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	24688	44688	69376
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	27688	47688	75376
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	24688	44688	69376
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	26688	46688	73376
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	22288	48688	70976
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	23688	43688	67376
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	22688	41688	64376
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13698	41688	55386
EOF

_run_script "totalN"

#---------------------------------------------------------------------------------
# get n from caseN and controlN
_setup "use stats total N for totalN"

cat <<EOF > ./metafile.yaml
stats_TotalN: 13688
EOF

cat <<EOF | gzip -c > ./input_file.tsv.gz
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P     
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663
EOF

cat <<EOF > ./expected-result_1.tsv
0	RSID	CHR	POS	EffectAllele	OtherAllele	EAF	B	SE	P     	N
1	rs6439928	3	141663261	T	C	0.658	-0.0157	0.0141	0.2648	13688
10	rs6463169	7	42980893	T	C	0.825	-0.0219	0.0171	0.2012	13688
100	rs6831643	4	99833465	T	C	0.669	-0.0321	0.0137	0.0193	13688
1000	rs10197378	2	29092758	A	G	0.183	-0.0189	0.0155	0.2226	13688
1001	rs10021082	4	100801356	T	C	0.958	0.0319	0.0264	0.2265	13688
1002	rs12709653	18	27735538	A	G	0.775	-0.0142	0.0142	0.3176	13688
1003	rs12726220	1	150984623	A	G	0.948	-0.0315	0.0277	0.2547	13688
1004	rs12739293	1	118812591	T	C	0.133	0.007	0.0175	0.6873	13688
1005	rs12754538	1	8408079	T	C	0.308	-6e-04	0.015	0.9663	13688
EOF

_run_script "totalN"
