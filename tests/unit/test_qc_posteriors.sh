#!/usr/bin/env bash

set -euo pipefail

test_script="qc_posteriors"
initial_dir=$(pwd)"/${test_script}"
curr_case=""

mkdir "${initial_dir}"
cd "${initial_dir}"

#=================================================================================
# Helpers
#=================================================================================

function _setup {
  mkdir "${1}"
  cd "${1}"
  curr_case="${1}"
}

function _check_results {
  obs=$1
  exp=$2
  if ! diff ${obs} ${exp} &> ./difference; then
    echo "- [FAIL] ${curr_case}"
    cat ./difference 
    exit 1
  fi

}

function _run_script {

  "${test_script}.sh" /pgscalculator/bin/R/qc_posteriors.R ./posteriors.tsv ./input_file.tsv ./input_file_header.tsv > ./observed-results.tsv

  _check_results ./observed-results.tsv ./expected-result_1.tsv

  echo "- [OK] ${curr_case}"

  cd "${initial_dir}"
}

echo ">> Test ${test_script}"

#=================================================================================
# Cases
#=================================================================================

#---------------------------------------------------------------------------------
# base case

_setup "base_case"

cat <<EOF > ./posteriors.tsv
    Id                 Name  Chrom     Position     A1     A2        A1Frq     A1Effect           SE            PIP  LastSampleEff
     1            rs2306409     10      1046712      G      A     0.480000    -0.001868     0.007655     0.59375042      -0.000000
     2           rs11253560     10      1047226      T      G     0.800000    -0.003694     0.008603     0.61874986      -0.000000
     3            rs7099607     10      1048343      T      C     0.490000    -0.001781     0.007496     0.62499976      -0.000000
     4            rs2620942     10      1048398      A      G     0.290000    -0.001123     0.007422     0.60375035      -0.000000
     5            rs2398009     10     10045145      A      G     0.480000    -0.011866     0.015830     0.76124984      -0.000000
     6           rs17147020     10     10049589      A      G     0.900000    -0.000682     0.008986     0.60874969      -0.000000
     7           rs10128184     10     10050347      G      A     0.960000     0.005232     0.013680     0.64625013      -0.000531
     8           rs11256439     10     10054385      T      G     0.710000     0.009960     0.013042     0.71375030      -0.000000
     9            rs7091976     10     10054916      T      C     0.960000    -0.017516     0.026549     0.73999995      -0.000000
    10           rs17147056     10     10065682      A      G     0.950000     0.002279     0.010306     0.63125020      -0.016610
    11           rs10905651     10     10073544      G      A     0.470000    -0.015701     0.016939     0.81249964      -0.032839
    12             rs957929     10     10074587      C      T     0.920000    -0.002831     0.011239     0.66624969      -0.000000
    13           rs11190363     10    101762385      A      C     0.530000     0.000855     0.007920     0.58749974      -0.000000
    14            rs7078766     10    101764893      C      T     0.930000    -0.003807     0.010814     0.61624968      -0.032975
    15            rs7088596     10    101766998      C      T     0.590000     0.000422     0.007996     0.58124948      -0.000000
    16            rs1986646     10    101767725      C      T     0.920000     0.013792     0.019075     0.73500007       0.048954
    17           rs11190365     10    101774323      A      G     0.970000    -0.000103     0.010450     0.64499986      -0.000000
    18           rs11593328     10    101775402      T      C     0.600000    -0.001871     0.009417     0.64499974      -0.007595
    19           rs11591518     10    101775611      C      T     0.670000     0.003130     0.010955     0.62499988      -0.015146
    20           rs10883434     10    101780614      T      C     0.620000    -0.000520     0.009175     0.63125026       0.017998
    21            rs7089847     10    101784816      A      G     0.940000    -0.001564     0.010394     0.60375023      -0.000000
    22            rs4919418     10    101792441      A      C     0.610000     0.000598     0.008029     0.58999985      -0.000000
    23            rs2862928     10    101798346      T      C     0.540000     0.000964     0.008376     0.59875000      -0.000000
    24           rs11190378     10    101799754      T      C     0.580000    -0.000278     0.008390     0.60000044       0.001829
    25           rs11593916     10    101809659      G      A     0.650000    -0.002783     0.011922     0.62375057      -0.000000
    26            rs7091871     10    101810304      C      T     0.940000     0.002421     0.010584     0.59125000      -0.000000
    27           rs11190381     10    101814302      A      G     0.970000    -0.006366     0.015921     0.66250032      -0.052953
    28            rs2902364     10    101817542      T      C     0.660000    -0.003687     0.012128     0.62124991      -0.000000
    29            rs2862925     10    101817557      C      T     0.580000    -0.000403     0.008824     0.64874971      -0.000000
EOF

cat <<EOF > ./input_file.tsv
CHR     POS     0       RSID    EffectAllele    OtherAllele     B       SE      Z       P       OR      EAF_1KG INFO    N
10      100000235       5749828 rs11596870      C       T       0.000500        0.0117  0.045887        0.9634  1.0005  0.69    0.979   111487
10      100002628       5749835 rs11190363      A       C       -0.000500       0.0107  -0.048899       0.961   0.9995  0.53    0.991   111487
10      100004827       5749840 rs7902856       A       C       -0.007095       0.0108  -0.651692       0.5146  0.99293 0.59    0.985   111487
10      100005136       5749841 rs7078766       C       T       -0.027196       0.0203  -1.339217       0.1805  0.97317 0.93    0.994   111487
10      100007241       5749852 rs7088596       C       T       -0.007204       0.0109  -0.661643       0.5082  0.992822        0.59    0.981   111487
10      100007968       5749858 rs1986646       C       T       0.060192        0.0215  2.803827        0.00505 1.06204 0.92    0.923   111487
10      100014566       5749885 rs11190365      A       G       -0.032296       0.0278  -1.161349       0.2455  0.96822 0.97    0.874   111487
10      100015645       5749891 rs11593328      T       C       -0.004199       0.011   -0.382352       0.7022  0.99581 0.6     0.987   111487
10      100015854       5749892 rs11591518      C       T       0.008206        0.0116  0.710168        0.4776  1.00824 0.67    0.987   111487
EOF

cat <<EOF > ./expected-result_1.tsv
Name Id Chrom Position A1 A2 A1Frq A1Effect SE PIP LastSampleEff B pos blownUp
rs11190363 13 10 101762385 A C 0.53 0.000855 0.00792 0.58749974 0 -5e-04 1 0
rs7078766 14 10 101764893 C T 0.93 -0.003807 0.010814 0.61624968 -0.032975 -0.027196 2 0
rs7088596 15 10 101766998 C T 0.59 0.000422 0.007996 0.58124948 0 -0.007204 3 0
rs1986646 16 10 101767725 C T 0.92 0.013792 0.019075 0.73500007 0.048954 0.060192 4 0
rs11190365 17 10 101774323 A G 0.97 -0.000103 0.01045 0.64499986 0 -0.032296 5 0
rs11593328 18 10 101775402 T C 0.6 -0.001871 0.009417 0.64499974 -0.007595 -0.004199 6 0
rs11591518 19 10 101775611 C T 0.67 0.00313 0.010955 0.62499988 -0.015146 0.008206 7 0
EOF

_run_script

