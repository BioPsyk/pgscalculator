#!/usr/bin/env bash

set -euo pipefail

test_script="filter_NA_coordinates"
initial_dir=$(pwd)"/${test_script}"
curr_case=""

mkdir "${initial_dir}"
cd "${initial_dir}"

#=================================================================================
# Helpers
#=================================================================================

function _setup {
  mkdir "${1}"
  cd "${1}"
  curr_case="${1}"
}

function _check_results {
  obs=$1
  exp=$2
  if ! diff ${obs} ${exp} &> ./difference; then
    echo "- [FAIL] ${curr_case}"
    cat ./difference 
    exit 1
  fi

}

function _run_script {

  "${test_script}.sh" ./input_file.tsv > ./observed-results.tsv
  _check_results ./observed-results.tsv ./expected-result_1.tsv

  echo "- [OK] ${curr_case}"

  cd "${initial_dir}"
}

echo ">> Test ${test_script}"

#=================================================================================
# Cases
#=================================================================================

#---------------------------------------------------------------------------------
# Add n

_setup "remove NAs"

cat <<EOF > ./input_file.tsv
CHR	POS	CHR	POS	0	RSID	EffectAllele	OtherAllele	B	SE	Z	P	OR	EAF_1KG	INFO
10	101759992	10	100000235	770072	rs11596870	C	T	0.006121	0.0236	0.258268	0.7962	1.00614	0.69	0.956
10	101762385	10	100002628	770073	rs11190363	A	C	0.013903	0.0214	0.660396	0.509	1.014	0.53	0.979
10	101764584	10	100004827	770074	rs7902856	A	C	0.018822	0.0216	0.893480	0.3716	1.019	0.59	0.984
10	101764893	10	100005136	770075	rs7078766	C	T	0.029530	0.0414	0.712428	0.4762	1.02997	0.93	0.952
10	101766998	10	100007241	770076	rs7088596	C	T	0.018675	0.0216	0.865435	0.3868	1.01885	0.59	0.982
10	101767725	10	100007968	770077	rs1986646	C	T	-0.012916	0.0424	-0.313501	0.7539	0.987167	0.92	0.864
NA	NA	10	10000862	728050	rs7093588	T	C	-0.012984	0.0212	-0.614477	0.5389	0.9871	0.47	0.991
NA	NA	10	100015699	770099	rs11593399	A	T	-0.010499	0.099	-0.477599	0.699	0.9899	0.9	0.999
10	101775402	10	100015645	770079	rs11593328	T	C	-0.010454	0.022	-0.477509	0.633	0.9896	0.6	0.963
10	101775611	10	100015854	770080	rs11591518	C	T	-0.022740	0.0232	-0.999195	0.3177	0.977517	0.67	0.958
EOF

cat <<EOF > ./expected-result_1.tsv
CHR	POS	CHR	POS	0	RSID	EffectAllele	OtherAllele	B	SE	Z	P	OR	EAF_1KG	INFO
10	101759992	10	100000235	770072	rs11596870	C	T	0.006121	0.0236	0.258268	0.7962	1.00614	0.69	0.956
10	101762385	10	100002628	770073	rs11190363	A	C	0.013903	0.0214	0.660396	0.509	1.014	0.53	0.979
10	101764584	10	100004827	770074	rs7902856	A	C	0.018822	0.0216	0.893480	0.3716	1.019	0.59	0.984
10	101764893	10	100005136	770075	rs7078766	C	T	0.029530	0.0414	0.712428	0.4762	1.02997	0.93	0.952
10	101766998	10	100007241	770076	rs7088596	C	T	0.018675	0.0216	0.865435	0.3868	1.01885	0.59	0.982
10	101767725	10	100007968	770077	rs1986646	C	T	-0.012916	0.0424	-0.313501	0.7539	0.987167	0.92	0.864
10	101775402	10	100015645	770079	rs11593328	T	C	-0.010454	0.022	-0.477509	0.633	0.9896	0.6	0.963
10	101775611	10	100015854	770080	rs11591518	C	T	-0.022740	0.0232	-0.999195	0.3177	0.977517	0.67	0.958
EOF

_run_script

